# InsightBI 時系列分析設計書

## 現状の課題

現在のInsightBIは「2025年9月末時点」の1スナップショットのみ。
経営管理には**2つの時間軸**が必要。

---

## 経営管理における2つの時間軸

### 軸1: 観測時点（いつ時点のデータか）

```
4月 → 6月 → 9月 → 12月 → 3月
 │      │      │       │      │
 │      │      │       │      └─ 期末確定
 │      │      │       └─ Q3締め・着地予想
 │      │      └─ Q2締め・上期確定 ← 現在ここ
 │      └─ Q1締め
 └─ 期初予算
```

**各時点で見えるもの:**
- 4月時点: 期初予算・前年繰越
- 6月時点: Q1実績 + Q2-Q4予想
- 9月時点: 上期実績 + 下期予想
- 12月時点: Q3実績 + Q4予想
- 3月時点: 通期実績確定

---

### 軸2: 分析期間（どの期間を見るか）

```
┌─────────────────────────────────────────────────────┐
│                    2025年度（4月〜3月）              │
├────────────┬────────────┬────────────┬────────────┤
│    Q1      │    Q2      │    Q3      │    Q4      │
│  4-6月     │  7-9月     │  10-12月   │  1-3月     │
└────────────┴────────────┴────────────┴────────────┘

分析パターン:
- 年度累計（YTD）: 4月〜現在月
- 四半期: Q1, Q2, Q3, Q4 単独
- 月次: 各月単独
- 通期予想: 年度全体の見通し
- 前年同期比: 昨年同時期との比較
```

---

## 提案するデータ構造

### 1. 月次スナップショット型

```typescript
interface MonthlySnapshot {
  period: string;           // "2025-04", "2025-05", ...
  asOfDate: string;         // データ確定日
  type: 'actual' | 'forecast' | 'budget';

  // 全社サマリー
  summary: {
    revenue: number;
    grossProfit: number;
    grossMarginRate: number;
  };

  // 支社別
  branches: {
    [branchName: string]: {
      revenue: number;
      grossProfit: number;
      grossMarginRate: number;
      segments: { [seg: string]: SegmentData };
    };
  };
}

interface TimeSeriesData {
  fiscalYear: string;       // "2025"
  months: MonthlySnapshot[];  // 12ヶ月分

  // 累計計算用
  ytd: {                    // Year To Date
    actual: MonthlySnapshot;
    budget: MonthlySnapshot;
    forecast: MonthlySnapshot;
  };
}
```

### 2. 予算・実績・見通しの3層構造

```typescript
interface PeriodComparison {
  period: string;
  budget: number;      // 期初予算
  forecast: number;    // 最新見通し
  actual: number;      // 実績（確定月のみ）

  // 差異分析
  budgetVariance: number;     // 予算差異
  forecastVariance: number;   // 見通し差異
  yoyChange: number;          // 前年比
}
```

---

## UI設計案

### ヘッダー部分に期間セレクター追加

```
┌─────────────────────────────────────────────────────────────────┐
│ InsightBI 経営ダッシュボード                                      │
│                                                                  │
│  観測時点: [2025年9月末 ▼]    分析期間: [上期累計 ▼]             │
│                                                                  │
│  比較モード: [前年同期 ▼]     表示: [予算/実績/見通し ☑☑☑]      │
└─────────────────────────────────────────────────────────────────┘
```

### 新しい分析ビュー

#### A. 月次推移チャート
```
売上・粗利の月次推移
     ┌──────────────────────────────────────────┐
  億 │    ▓▓                                    │ ← 予算
 12 │    ██▓▓                                  │ ← 実績
 10 │  ▓▓██▓▓▓▓                               │
  8 │  ████████▓▓▓▓▓▓                         │ ← 見通し
  6 │  ██████████████▓▓▓▓▓▓                   │
  4 │  ████████████████████                   │
  2 │  ████████████████████                   │
     └──┴──┴──┴──┴──┴──┴──┴──┴──┴──┴──┴──┴──┘
       4  5  6  7  8  9 10 11 12  1  2  3 月
```

#### B. 予算達成進捗
```
予算消化率 vs 時間経過
     ┌──────────────────────────────────────────┐
100%│                              ●理想ライン │
 80%│                    ●実績                 │
 60%│              ●                          │
 40%│        ●                                │
 20%│  ●                                      │
     └──┴──────┴──────┴──────┴──────┴──────┴──┘
       Q1    Q2    Q3    Q4   期末
```

#### C. 前年同期比較
```
支社別 前年同期比
            │◀── 減少        増加 ──▶│
東京本社    │        ████████████████  │ +8.5%
大阪支社    │             ███████████  │ +5.2%
名古屋支社  │                ████████  │ +3.1%
福岡支社    │                 ███████  │ +2.8%
札幌支社    │  ████                    │ -12.5%
海外事業部  │              ██████████  │ +4.2%
```

#### D. 見通し変動トラッキング
```
通期見通しの推移（いつ時点でいくらと予想したか）
     ┌──────────────────────────────────────────┐
150億│  ●期初予算                               │
    │    ↘                                     │
145億│      ●6月見通し                         │
    │        ↘                                 │
140億│          ●9月見通し ← 現在              │
    │            ↘                             │
135億│              ●12月見通し（予想）         │
     └──┴──────┴──────┴──────┴──────┴──────┴──┘
       4月    6月    9月   12月   3月
```

---

## 実装ステップ

### Phase 1: データ構造拡張
1. `lib/types.ts` に時系列型を追加
2. `data/performance-timeseries.json` を作成（デモ用12ヶ月データ）
3. 期間セレクター用のユーティリティ関数

### Phase 2: UI基盤
1. 期間セレクターコンポーネント
2. 比較モードトグル
3. 表示切替（予算/実績/見通し）

### Phase 3: 時系列チャート
1. 月次推移チャート（Recharts LineChart）
2. 予算達成進捗チャート
3. 前年同期比較チャート

### Phase 4: 統合
1. 既存ダッシュボードとの統合
2. 期間選択に応じたデータフィルタリング
3. ドリルダウン対応

---

## デモデータ設計

12ヶ月分のデータを生成:
- 4〜9月: 実績データ
- 10〜3月: 見通しデータ
- 全月: 予算データ

季節性を反映:
- Q1（4-6月）: やや低調（期初）
- Q2（7-9月）: 中程度
- Q3（10-12月）: 繁忙期
- Q4（1-3月）: 期末追い込み

---

## 期待効果

1. **経営判断の質向上**
   - 「今どこにいるか」だけでなく「どう推移してきたか」が見える
   - 予算との乖離がいつ発生したか追跡可能

2. **予実管理の高度化**
   - 見通しの精度が時間とともに向上しているか確認
   - 楽観/悲観シナリオの検証

3. **アクション効果の可視化**
   - 改善施策の効果を時系列で追跡
   - Before/After比較が容易に
